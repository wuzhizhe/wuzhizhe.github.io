<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Cache-Control与Nginx配置"><meta name="keywords" content="cache-control,nginx,proxy_cache"><meta name="author" content="木兄,undefined"><meta name="copyright" content="木兄"><title>Cache-Control与Nginx配置 | 木兄博客</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存相关问题"><span class="toc-number">1.</span> <span class="toc-text">缓存相关问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#浏览器配置缓存策略以及导致的问题"><span class="toc-number">2.</span> <span class="toc-text">浏览器配置缓存策略以及导致的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-SERVER配置浏览器缓存策略"><span class="toc-number">3.</span> <span class="toc-text">HTTP SERVER配置浏览器缓存策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-SERVER配置本身的缓存策略"><span class="toc-number">4.</span> <span class="toc-text">HTTP SERVER配置本身的缓存策略</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">木兄</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">27</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">55</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image: url(true)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">木兄博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Cache-Control与Nginx配置</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-07-27</time><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2017/07/27/Cache-Control与Nginx配置/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2017/07/27/Cache-Control与Nginx配置/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="缓存相关问题"><a href="#缓存相关问题" class="headerlink" title="缓存相关问题"></a>缓存相关问题</h2><p>  项目上最近要处理前端缓存的问题，因为缓存之前一直没有处理好，所以就是时不时的有点问题，经常因为缓存不更新导致访问的都是旧数据。</p>
<p>  这里其实分为两个地方要处理的缓存，第一个是浏览器本身的缓存，第二个是Http代理服务器（这里用Nginx）的缓存问题。</p>
<h2 id="浏览器配置缓存策略以及导致的问题"><a href="#浏览器配置缓存策略以及导致的问题" class="headerlink" title="浏览器配置缓存策略以及导致的问题"></a>浏览器配置缓存策略以及导致的问题</h2><p>  chrome浏览器默认缓存，如果http服务器没有显式的设置缓存的策略，那么浏览器将会自动缓存get请求的数据，并且下一次请求时如果请求的数据url没有发生变化那么就不会去请求服务器直接用缓存的数据显示到浏览器上。</p>
<p>  这就导致了新数据、图片、CSS等不生效。</p>
<p>  一开始通过前端代码的方式来解决这些问题，请求url后面加上一个时间戳类似的数据串，这样每次请求的数据不一样也就不会有缓存的问题，用此来解决总是不刷新缓存的问题。<br>  但是现在项目的代码是纯静态代码，HTML的，不是模板生成的，也不是PHP这一类的，所以有些文件不能用动态的字符串来修改请求的URL了，最明显的例子就是HTML中的img标签，或者css里的一些background的url等，这些内容纯静态，只能写死，这种文件一旦更新就会有缓存的问题，缓存更新不及时好像程序有问题。</p>
<h2 id="HTTP-SERVER配置浏览器缓存策略"><a href="#HTTP-SERVER配置浏览器缓存策略" class="headerlink" title="HTTP SERVER配置浏览器缓存策略"></a>HTTP SERVER配置浏览器缓存策略</h2><p>  因为浏览器的缓存策略是有Cache-Control控制的，所以需要在HTTP SERVER的Response Header里设置Cache-Control，HTTP SERVER控制了缓存策略，这样就能处理浏览器的缓存了。<br>  Cache-Control不在这里详细展开，简单说下，缓存的设置有这几种策略：no-store(不缓存) no-cache(每次请求时检查缓存是否过期，如果过期，获取新内容) 以及其他的一些设置。</p>
<p>  Nginx的配置: add_header Cache-Control ‘no-cache’;<br>  最好配置在每个location里面，不同的location有不同的缓存策略。<br>  MDN上简单介绍了<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control" target="_blank" rel="noopener">Cache-Control</a>，与Cache-Control相关的还有Expires Pragma 返回头的指令。不在此展开。</p>
<p>  Nginx HTTP模块相关配置：</p>
<h2 id="HTTP-SERVER配置本身的缓存策略"><a href="#HTTP-SERVER配置本身的缓存策略" class="headerlink" title="HTTP SERVER配置本身的缓存策略"></a>HTTP SERVER配置本身的缓存策略</h2><p>  HTTP SERVER除了可以控制浏览器的缓存策略之外，还可以配置自己作为缓存代理服务器的缓存策略。</p>
<p>  这种模式下的Nginx是一个简单的反向代理服务器并不是一个纯粹的HTTP SERVER。浏览器请求模式大概如下：</p>
<p>  Browser Client —–&gt;  Nginx Proxy —–&gt; Apache (or other) Http server</p>
<p>  这里的Nginx就是一个反向代理，既然是代理就可以设置缓存，这里的缓存就是proxy_cache。</p>
<p>  设置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 以下的在http 模块里</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_cache_path D:<span class="regexp">/comproject/</span>cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">10</span>m max_size=<span class="number">10</span>g inactive=<span class="number">10</span>s use_temp_path=off;</span><br><span class="line">proxy_cache_methods GET HEAD POST;</span><br><span class="line"></span><br><span class="line"># 这些在具体的location模块里：</span><br><span class="line">proxy_cache my_cache;</span><br><span class="line">proxy_cache_revalidate on;</span><br><span class="line">proxy_cache_min_uses <span class="number">1</span>;</span><br><span class="line">proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">proxy_cache_use_stale error timeout updating invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">proxy_cache_valid <span class="number">200</span> <span class="number">10</span>s;</span><br><span class="line">expires <span class="number">10</span>s;</span><br><span class="line">add_header Cache-Control <span class="string">'no-cache'</span>;</span><br><span class="line">proxy_pass http:<span class="comment">//fdp;</span></span><br></pre></td></tr></table></figure>
<p>  上面设置缓存的路径，缓存的方法以及其他的配置都在官网，具体的可以看<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">nginx官网</a></p>
<p>  这里有个关键点就是必须有后面的HTTP SERVER，在Nginx用upstream与proxy_pass来配置，这样就是一个代理服务器了，可以缓存数据了。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">木兄</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://muxblog.tk/2017/07/27/Cache-Control与Nginx配置/">https://muxblog.tk/2017/07/27/Cache-Control与Nginx配置/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://muxblog.tk" target="_blank">木兄博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/cache-control/">cache-control</a><a class="post-meta__tags" href="/tags/nginx/">nginx</a><a class="post-meta__tags" href="/tags/proxy-cache/">proxy_cache</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/08/04/旋风要倒下了，怀念下以前的下载生活/"><i class="fa fa-chevron-left">  </i><span>旋风要倒下了，怀念下以前的下载生活</span></a></div><div class="next-post pull-right"><a href="/2017/06/29/HTTP安全相关响应首部/"><span>HTTP安全相关响应首部</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://muxblog.tk/2017/07/27/Cache-Control与Nginx配置/';
  this.page.identifier = '2017/07/27/Cache-Control与Nginx配置/';
  this.page.title = 'Cache-Control与Nginx配置';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'dazhizhe' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://dazhizhe.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2018 By 木兄</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>